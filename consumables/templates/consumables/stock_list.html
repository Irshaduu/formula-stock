{% extends 'consumables/base.html' %}

{% block content %}
<style>
    :root {
        --panel: #121212;
        --muted: #9aa0a6;
        --accent-blue: #1177ff;
        --accent-red: #ff4d4f;
        --card-border: rgba(255, 255, 255, 0.04);
        --success: #20c997;
    }

    .restock-container {
        padding: 10px;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        color: #e8eef7;
    }

    /* ---------- TOP ROW ---------- */
    .top-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
    }

    .top-row h2 {
        font-size: 1.02rem;
        margin: 0;
        white-space: nowrap;
    }

    .search-container {
        flex: 1;
        min-width: 0;
    }

    .tiny-search {
        width: 100%;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--border-color);
        background: var(--input-bg);
        color: var(--text-primary);
        font-size: 0.9rem;
        outline: none;
    }

    .tiny-search::placeholder {
        color: var(--muted);
    }

    .low-stock-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        font-size: 0.75rem;
        background: var(--accent-red);
        color: #fff;
        border-radius: 8px;
        text-decoration: none;
        white-space: nowrap;
    }

    /* ---------- CATEGORY ---------- */
    .category-section {
        margin: 8px 0 14px;
    }

    .category-title {
        color: var(--accent-blue);
        font-weight: 700;
        margin: 0 0 6px 6px;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    /* ---------- ITEM CARD ---------- */
    .item-card {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        margin: 4px 0;
        border-radius: 8px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
        border: 1px solid var(--card-border);
    }

    .item-info {
        flex: 1;
        min-width: 0;
    }

    .item-name {
        font-weight: 600;
        font-size: 0.94rem;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        /* Indication it's interactive */
    }

    .item-name.expanded {
        white-space: normal;
        overflow: visible;
        word-break: break-word;
    }

    .item-stock {
        font-size: 0.72rem;
        margin-top: 2px;
    }

    .stock-badge {
        padding: 1px 6px;
        border-radius: 999px;
        font-size: 0.7rem;
        margin-right: 4px;
    }

    .avg-badge {
        background: rgba(0, 122, 255, 0.1);
        color: var(--accent-blue);
    }

    .cur-badge {
        background: rgba(32, 201, 151, 0.08);
    }

    /* ---------- CONTROLS ---------- */
    .controls {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    input[type="number"] {
        width: 62px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: var(--panel);
        color: #fff;
        font-weight: 600;
        text-align: center;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* ---------- SAVE BUTTON ---------- */
    .btn-save {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(180deg, #2a2a2a, #171717);
        color: #e8eef7;
        font-size: 0.84rem;
        font-weight: 500;
        cursor: pointer;
        box-shadow:
            0 2px 6px rgba(0, 0, 0, 0.35),
            inset 0 1px 0 rgba(255, 255, 255, 0.06);
        transition: all .15s ease;
    }

    .btn-save svg {
        width: 13px;
        height: 13px;
        opacity: .9;
    }

    .btn-save:hover {
        box-shadow:
            0 0 0 1px rgba(32, 201, 151, .35),
            0 4px 10px rgba(32, 201, 151, .15);
    }

    .btn-save:active {
        transform: translateY(1px) scale(.98);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, .45);
    }
</style>

<div class="restock-container">

    <div class="top-row">
        <h2>Restock</h2>

        <div class="search-container">
            <input id="restockSearch" class="tiny-search" type="text" placeholder="Search items or category…">
        </div>

        <a href="{% url 'low_stock_list' %}" class="low-stock-btn">
            ● Low Stock
        </a>
    </div>

    {% for category in categories %}
    <div class="category-section">
        <h3 class="category-title">{{ category.name }}</h3>

        {% for item in category.items.all %}
        <form method="post" action="{% url 'update_stock' item.id %}" class="item-card" data-default-display="flex"
            style="background: linear-gradient(90deg, var(--card-bg) {{ item.stock_percentage|floatformat:0 }}%, transparent {{ item.stock_percentage|floatformat:0 }}%);">
            {% csrf_token %}

            <div class="item-info">
                <div class="item-name" onclick="this.classList.toggle('expanded')">
                    {{ item.name }}
                    <span style="display:none">{{ category.name }}</span>
                </div>
                <div class="item-stock">
                    <span class="stock-badge avg-badge">Avg {{ item.average_stock }}</span>
                    <span class="stock-badge cur-badge" style="color:{{ item.stock_status_color }}">
                        Cur {{ item.current_stock }}
                    </span>
                </div>
            </div>

            <div class="controls">
                <input type="number" name="current_stock" value="{{ item.current_stock }}" inputmode="decimal"
                    step="0.1"
                    style="background-color: {{ item.stock_status_color }}; border-color: {{ item.stock_status_color }}; color: white; font-weight: bold;">
                <button type="submit" class="btn-save">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <path d="M17 21v-8H7v8" />
                        <path d="M7 3v6h8" />
                    </svg>
                    Save
                </button>
            </div>
        </form>
        {% endfor %}
    </div>
    {% endfor %}

</div>

<script>
    (function () {
        const input = document.getElementById('restockSearch');
        const cards = [...document.querySelectorAll('.item-card')];
        const categories = [...document.querySelectorAll('.category-section')];

        cards.forEach(c => {
            c.dataset.defaultDisplay = getComputedStyle(c).display || 'flex';
        });

        function debounce(fn, ms) {
            let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }
        }

        function filter() {
            const q = input.value.toLowerCase().trim();
            cards.forEach(card => {
                card.style.display =
                    !q || card.textContent.toLowerCase().includes(q)
                        ? card.dataset.defaultDisplay
                        : 'none';
            });

            categories.forEach(cat => {
                cat.style.display =
                    [...cat.querySelectorAll('.item-card')]
                        .some(c => c.style.display !== 'none')
                        ? 'block' : 'none';
            });
        }

        input.addEventListener('input', debounce(filter, 180));
    })();
</script>
{% endblock %}